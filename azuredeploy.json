{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "storageAccountPrefix": {
            "type": "string",
            "metadata": {
                "description": "Unique namespace for the Storage Account where the Virtual Machine's disks will be placed"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "myVNET",
            "metadata": {
                "description": "Name of the virtual network provisioned for the cluster"
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Administrator user name used when provisioning virtual machines"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Administrator password used when provisioning virtual machines"
            }
        },
        "dnsName": {
            "type": "string",
            "metadata": {
                "description": "Domain name for the publicly accessible apache instance"
            }
        },
        "masterVmSize": {
            "type": "string",
            "defaultValue": "Standard_D3",
            "allowedValues": [
                "Standard_D3",
                "Standard_D4"
            ],
            "metadata": {
                "description": "The size of the virtual machines used when provisioning the apache instance"
            }
        },
        "wildflyNodes": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "Number of WildFly node (2 is the default)"
            }
        },
        "slaveVmSize": {
            "type": "string",
            "defaultValue": "Standard_D3",
            "allowedValues": [
                "Standard_D3",
                "Standard_D4"
            ],
            "metadata": {
                "description": "The size of the virtual machines used when provisioning WildFly node(s)"
            }
        }
    },
    "variables": {
        "templateBaseUrl": "https://raw.githubusercontent.com/normalian/apache-wildfly-template/master/",
        "sharedTemplateUrl": "[concat(variables('templateBaseUrl'), 'shared-resources.json')]",
        "apacheTemplateUrl": "[concat(variables('templateBaseUrl'), 'apache-resources.json')]",
        "wildflyTemplateUrl": "[concat(variables('templateBaseUrl'), 'wildfly-resources.json')]",
        "networkSettings": {
            "virtualNetworkName": "[parameters('virtualNetworkName')]",
            "addressPrefix": "10.30.0.0/16",
            "subnet": {
                "dse": {
                    "name": "dse",
                    "prefix": "10.30.0.0/24",
                    "vnet": "[parameters('virtualNetworkName')]"
                }
            },
            "statics": {
                "wildflyRange": {
                    "base": "10.30.0.",
                    "start": 5
                },
                "apacheIp": "10.30.0.220"
            }
         },
        "namespace": "wildfly",
        "masterOsSettings": {
            "imageReference": {
                "publisher": "OpenLogic",
                "offer": "CentOS",
                "sku": "7.1",
                "version": "latest"
            },
            "scripts": [
                "https://raw.githubusercontent.com/normalian/apache-wildfly-template/master/apacheInstall.sh"
                //"https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/jenkins-on-ubuntu/jenkAddNode.groovy"
            ]
        },
        "slaveOsSettings": {
            "imageReference": {
                "publisher": "OpenLogic",
                "offer": "CentOS",
                "sku": "7.1",
                "version": "latest"
            },
            "scripts": [
                "https://raw.githubusercontent.com/normalian/apache-wildfly-template/master/wildflyInstall.sh"
            ]
        },
        "sharedStorageAccountName": "[parameters('storageAccountPrefix')]"
    },
    "resources": [
        {
            "name": "shared",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('sharedTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "namespace": {
                        "value": "[variables('namespace')]"
                    },
                    "region": {
                        "value": "[resourceGroup().location]"
                    },
                    "networkSettings": {
                        "value": "[variables('networkSettings')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('sharedStorageAccountName')]"
                    }
                }
            }
        },
        {
            "name": "apacheNode",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'shared')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('apacheTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "region": {
                        "value": "[resourceGroup().location]"
                    },
                    "storageAccountName": {
                        "value": "[variables('sharedStorageAccountName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "vmbasename": {
                        "value": "apache"
                    },
                    "subnet": {
                        "value": "[variables('networkSettings').subnet.dse]"
                    },
                    "dnsname": {
                        "value": "[parameters('dnsName')]"
                    },
                    "staticIp": {
                        "value": "[variables('networkSettings').statics.apacheIp]"
                    },
                    "vmSize": {
                        "value": "[parameters('masterVmSize')]"
                    },
                    "osSettings": {
                        "value": "[variables('masterOsSettings')]"
                    }
                }
            }
        },
        {
            "name": "[concat('wildflyNode', copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'shared')]",
                "[concat('Microsoft.Resources/deployments/', 'apacheNode')]"
            ],
            "copy": {
                "name": "vmLoop",
                "count": "[parameters('wildflyNodes')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                "uri": "[variables('wildflyTemplateUrl')]",
                "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "region": {
                        "value": "[resourceGroup().location]"
                    },
                    "storageAccountName": {
                        "value": "[variables('sharedStorageAccountName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "namespace": {
                        "value": "[variables('namespace')]"
                    },
                    "vmbasename": {
                        "value": "[concat('Slave', copyindex())]"
                    },
                    "masterNode": {
                        "value": "[variables('networkSettings').statics.apacheIp]"
                    },
                    "subnet": {
                        "value": "[variables('networkSettings').subnet.dse]"
                    },
                    "vmSize": {
                        "value": "[parameters('slaveVmSize')]"
                    },
                    "osSettings": {
                        "value": "[variables('slaveOsSettings')]"
                    }
                }
            }
        }
     ]
}